<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script>
  let john = {
    name: 'John',
  };

  let array = [john];

  let map = new Map();
  map.set(john, '...');

  john = null;
</script>
<script>
  let weakMap = new WeakMap();

  let obj = {};

  weakMap.set(obj, 'ok');

  let john2 = {name: 'john'};

  let weakMap2 = new WeakMap();
  weakMap2.set(john2);

  console.log(weakMap2);
  john2 = null;
  console.log(weakMap2);
  console.log(john2);
</script>
<script>
  // ğŸ“ visitsCount.js
  let visitsCountMap = new WeakMap(); // map: user => visits count

  // é€’å¢ç”¨æˆ·æ¥è®¿æ¬¡æ•°
  function countUser(user) {
    let count = visitsCountMap.get(user) || 0;
    visitsCountMap.set(user, count + 1);
  }

  // ğŸ“ main.js
  let john3 = {name: 'John'};

  countUser(john3); // count his visits

  // ä¸ä¹…ä¹‹åï¼Œjohn ç¦»å¼€äº†
  john3 = null;
</script>
<script>
  // ğŸ“ cache.js
  let cache = new WeakMap();

  // è®¡ç®—å¹¶è®°ç»“æœ
  function process(obj) {
    if (!cache.has(obj)) {
      let result = /* calculate the result for */ obj;

      cache.set(obj, result);
    }

    return cache.get(obj);
  }

  // ğŸ“ main.js
  let obj4 = {/* some object */};

  let result1 = process(obj4);
  let result2 = process(obj4);

  // â€¦â€¦ç¨åï¼Œæˆ‘ä»¬ä¸å†éœ€è¦è¿™ä¸ªå¯¹è±¡æ—¶ï¼š
  obj4 = null;

  // æ— æ³•è·å– cache.sizeï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ª WeakMapï¼Œ
  // è¦ä¹ˆæ˜¯ 0ï¼Œæˆ–å³å°†å˜ä¸º 0
  // å½“ obj è¢«åƒåœ¾å›æ”¶ï¼Œç¼“å­˜çš„æ•°æ®ä¹Ÿä¼šè¢«æ¸…é™¤
</script>
<script>
  let visitedSet = new WeakSet();

  let john5 = {name: 'John'};
  let pete5 = {name: 'Pete'};
  let mary5 = {name: 'Mary'};

  visitedSet.add(john5); // John è®¿é—®äº†æˆ‘ä»¬
  visitedSet.add(pete5); // ç„¶åæ˜¯ Pete
  visitedSet.add(john5); // John å†æ¬¡è®¿é—®

  console.log(visitedSet.has(john5));
  console.log(visitedSet.has(mary5));

  john5 = null;
  console.log(visitedSet);
</script>
<script>
  let messages = [
    {text: 'Hello', from: 'John'},
    {text: 'How goes?', from: 'John'},
    {text: 'See you soon', from: 'Alice'},
  ];

  let readMessages = new WeakSet();
  let readMap = new WeakMap();

  // ä¸¤ä¸ªæ¶ˆæ¯å·²è¯»
  readMessages.add(messages[0]);
  readMessages.add(messages[1]);
  // readMessages åŒ…å«ä¸¤ä¸ªå…ƒç´ 

  // â€¦â€¦è®©æˆ‘ä»¬å†è¯»ä¸€éç¬¬ä¸€æ¡æ¶ˆæ¯ï¼
  readMessages.add(messages[0]);
  // readMessages ä»ç„¶æœ‰ä¸¤ä¸ªä¸é‡å¤çš„å…ƒç´ 

  readMap.set(messages[0], new Date(2017, 1, 1));

  // å›ç­”ï¼šmessage[0] å·²è¯»ï¼Ÿ
  console.log('Read message 0: ' + readMessages.has(messages[0])); // true

  messages.shift();
  // ç°åœ¨ readMessages æœ‰ä¸€ä¸ªå…ƒç´ ï¼ˆæŠ€æœ¯ä¸Šæ¥è®²ï¼Œå†…å­˜å¯èƒ½ç¨åæ‰ä¼šè¢«æ¸…ç†ï¼‰
  console.log(readMessages, readMap);
</script>
</body>
</html>
